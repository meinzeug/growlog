generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

enum LocationType {
  INDOOR
  OUTDOOR
}

enum Medium {
  SOIL
  COCO
  HYDRO
  OTHER
}

enum PlantTypeEnum {
  PHOTOPERIOD
  AUTOFLOWER
  UNKNOWN
}

enum PlantSex {
  FEMINIZED
  REGULAR
  UNKNOWN
}

enum PlantPhase {
  GERMINATION
  VEGETATIVE
  FLOWERING
  DRYING
  CURED
  FINISHED
}

enum PlantStatus {
  HEALTHY
  ISSUES
  SICK
  HARVESTED
  DEAD
}

enum LeafLogType {
  NOTE
  WATER
  FEED
  TRAINING
  DEFOLIATION
  TRANSPLANT
  PEST
  PH_ADJUST
  LIGHT_CHANGE
  OTHER
}

enum TaskStatus {
  OPEN
  DONE
  SKIPPED
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password_hash String
  role          Role      @default(USER)
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  last_login_at DateTime?

  grows         Grow[]
  plants        Plant[]
  logs          PlantLog[]
  photos        PlantPhoto[]
  tasks         Task[]
}

model Grow {
  id            String       @id @default(uuid())
  owner_user_id String
  name          String
  location_type LocationType
  notes         String?
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt

  owner        User          @relation(fields: [owner_user_id], references: [id])
  environments Environment[]
  plants       Plant[]
  tasks        Task[]
}

model Environment {
  id                 String  @id @default(uuid())
  grow_id            String
  name               String
  medium             Medium
  light_schedule     String? // e.g. "18/6"
  temperature_target Float?
  humidity_target    Float?
  notes              String?

  grow   Grow    @relation(fields: [grow_id], references: [id])
  plants Plant[]
}

model Plant {
  id             String        @id @default(uuid())
  grow_id        String
  environment_id String?
  owner_user_id  String
  name           String
  strain         String?
  plant_type     PlantTypeEnum @default(UNKNOWN)
  sex            PlantSex      @default(UNKNOWN)
  start_date     DateTime?     @db.Date
  phase          PlantPhase    @default(GERMINATION)
  phase_started_at DateTime?   @db.Date
  status         PlantStatus   @default(HEALTHY)
  notes          String?
  created_at     DateTime      @default(now())
  updated_at     DateTime      @updatedAt

  grow        Grow          @relation(fields: [grow_id], references: [id])
  environment Environment?  @relation(fields: [environment_id], references: [id])
  owner       User          @relation(fields: [owner_user_id], references: [id])
  logs        PlantLog[]
  photos      PlantPhoto[]
  tasks       Task[]
  metrics     PlantMetric[]
}

model PlantLog {
  id          String      @id @default(uuid())
  plant_id    String
  created_by  String
  logged_at   DateTime    @default(now())
  type        LeafLogType @default(NOTE)
  title       String?
  content     String?
  tags        String[]
  metrics_json Json?      // Flexible metrics if needed

  plant Plant @relation(fields: [plant_id], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [created_by], references: [id])
}

model PlantPhoto {
  id          String   @id @default(uuid())
  plant_id    String
  uploaded_by String
  taken_at    DateTime?
  file_path   String
  caption     String?
  created_at  DateTime @default(now())

  plant Plant @relation(fields: [plant_id], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [uploaded_by], references: [id])
}

model Task {
  id                    String     @id @default(uuid())
  owner_user_id         String
  grow_id               String?
  plant_id              String?
  title                 String
  description           String?
  due_at                DateTime
  repeat_rule           String?
  notify                Boolean    @default(false)
  notify_before_minutes Int?
  status                TaskStatus @default(OPEN)
  created_at            DateTime   @default(now())
  updated_at            DateTime   @updatedAt

  owner User   @relation(fields: [owner_user_id], references: [id])
  grow  Grow?  @relation(fields: [grow_id], references: [id])
  plant Plant? @relation(fields: [plant_id], references: [id])
}

model PlantMetric {
  id            String   @id @default(uuid())
  plant_id      String
  recorded_at   DateTime @default(now())
  height_cm     Float?
  ph            Float?
  ec            Float?
  temperature_c Float?
  humidity_pct  Float?
  notes         String?

  plant Plant @relation(fields: [plant_id], references: [id], onDelete: Cascade)
}
